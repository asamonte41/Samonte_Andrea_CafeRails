<div class="container mt-4">
  <h1 class="mb-4">Welcome to Cafe Rails</h1>
  <p class="lead">Discover our delicious pastries, beverages, and dessert kits</p>

  <!-- Category Navigation (Req 2.2) -->
  <div class="mb-4">
    <h5>Browse by Category:</h5>
    <div class="btn-group" role="group">
      <%= link_to "All Products", products_path, class: "btn btn-outline-primary #{'active' unless @selected_category}" %>

      <% @categories.each do |category| %>
        <%= link_to category.name,
            products_path(category_id: category.id),
            class: "btn btn-outline-primary #{@selected_category == category ? 'active' : ''}" %>
      <% end %>
    </div>
  </div>

  <!-- Filters (Req 2.4) -->
  <div class="mb-4">
    <h5>Filter Products:</h5>
    <div class="btn-group" role="group">
      <%= link_to "On Sale",
          products_path(on_sale: true, category_id: params[:category_id]),
          class: "btn btn-outline-success #{'active' if params[:on_sale]}" %>

      <%= link_to "New Arrivals",
          products_path(new_arrival: true, category_id: params[:category_id]),
          class: "btn btn-outline-info #{'active' if params[:new_arrival]}" %>

      <%= link_to "Recently Updated",
          products_path(recently_updated: true, category_id: params[:category_id]),
          class: "btn btn-outline-warning #{'active' if params[:recently_updated]}" %>
    </div>
  </div>

  <!-- Search Form (Req 2.6 ✯) -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Search Products</h5>

      <%= search_form_for @q, url: products_path, method: :get do |f| %>
        <div class="row g-3">
          <div class="col-md-4">
            <%= f.label :category_id_eq, "Category" %>
            <%= f.select :category_id_eq,
                options_for_select([["All Categories", ""]] + @categories.map { |c| [c.name, c.id] }, @q.category_id_eq),
                {}, { class: "form-select" } %>
          </div>

          <div class="col-md-6">
            <%= f.label :name_or_description_cont, "Keyword" %>
            <%= f.text_field :name_or_description_cont,
                placeholder: "Search by name or description...",
                class: "form-control" %>
          </div>

          <div class="col-md-2 d-flex align-items-end">
            <%= f.submit "Search", class: "btn btn-primary w-100" %>
          </div>
        </div>
      <% end %>

      <% if params[:q].present? %>
        <div class="mt-2">
          <%= link_to "Clear Search", products_path, class: "btn btn-sm btn-outline-secondary" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Products Grid (Req 2.1 ✯) -->
  <% if @products.any? %>
    <div class="row">
      <% @products.each do |product| %>
        <div class="col-md-4 col-lg-3 mb-4">
          <div class="card h-100">
            <% if product.image.attached? %>
              <%= link_to product_path(product) do %>
                <%= image_tag product.image, class: "card-img-top", style: "height: 200px; object-fit: cover;" %>
              <% end %>
            <% else %>
              <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                <span class="text-muted">No image</span>
              </div>
            <% end %>

            <div class="card-body d-flex flex-column">
              <h5 class="card-title"><%= product.name %></h5>
              <p class="card-text flex-grow-1"><%= truncate(product.description, length: 80) %></p>

              <div class="mt-auto">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="h4 mb-0 text-primary">$<%= number_with_precision(product.price, precision: 2) %></span>

                  <% if product.on_sale %>
                    <span class="badge bg-success">On Sale</span>
                  <% end %>

                  <% if product.new_arrival %>
                    <span class="badge bg-info">New</span>
                  <% end %>
                </div>

                <p class="text-muted small mb-2">
                  Category: <%= product.category.name %>
                </p>

                <%= link_to "View Details", product_path(product), class: "btn btn-primary w-100" %>
              </div>

            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Pagination (Req 2.5) -->
    <div class="d-flex justify-content-center mt-4">
      <%= paginate @products %>
    </div>

  <% else %>
    <div class="alert alert-info">
      <h4>No products found</h4>
      <p>Try adjusting your filters or search terms.</p>
      <%= link_to "View All Products", products_path, class: "btn btn-primary" %>
    </div>
  <% end %>
</div>
