<% if @order.nil? %>
  <p class="alert alert-warning">No order found. Please return to your cart and start checkout.</p>
  <%= link_to "Go to Cart", cart_index_path, class: "btn btn-secondary" %>
<% else %>
  <h1>Choose Payment Method for Order #<%= @order.id %></h1>
  <p>Total: $<%= '%.2f' % (@order.total_cents.to_f / 100) %></p>

  <div class="mt-4">
    <h3>Pay with Card (Inline)</h3>
    <%= link_to "Pay Inline", new_payment_path(order_id: @order.id), class: "btn btn-primary mb-3" %>
  </div>

  <div class="mt-4">
    <h3>Pay with Stripe Checkout (Hosted)</h3>
    <button id="stripe-checkout-btn" class="btn btn-success">Pay with Stripe</button>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const stripe = Stripe("<%= Rails.application.credentials.dig(:stripe, :public_key) %>");
      const checkoutButton = document.getElementById("stripe-checkout-btn");

      checkoutButton.addEventListener("click", async () => {
        const response = await fetch("<%= payments_create_checkout_session_path %>", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({ order_id: <%= @order.id %> })
        });

        const data = await response.json();
        if (data.url) {
          window.location.href = data.url;
        } else {
          alert("Unable to start Stripe checkout. Please try again.");
        }
      });
    });
  </script>
<% end %>
