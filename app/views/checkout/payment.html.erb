<h1>Payment â€” Choose Method</h1>

<p>Total: <%= number_to_currency(@order.total_cents / 100.0) %></p>

<h3>Select a payment method:</h3>
<div>
  <%= form_with url: create_payment_path, method: :post do |f| %>
    <%= hidden_field_tag :order_id, @order.id %>

    <div>
      <%= radio_button_tag :payment_method, "stripe_checkout", true %>
      <%= label_tag :payment_method_stripe_checkout, "Stripe Hosted Checkout" %>
    </div>

    <div>
      <%= radio_button_tag :payment_method, "card" %>
      <%= label_tag :payment_method_card, "Pay by Card (Inline)" %>
    </div>

    <%= submit_tag "Proceed to Payment", class: "btn btn-primary mt-2" %>
  <% end %>
</div>

<hr>

<div id="inline-card-container" style="display:none; max-width:500px;">
  <h3>Enter Card Details</h3>
  <div id="card-errors" role="alert" class="text-danger"></div>
  <div id="card-element" class="mb-3"></div>
  <button id="pay-button" class="btn btn-success">Pay Now</button>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const stripe = Stripe("<%= Rails.application.credentials.dig(:stripe, :public_key) %>");

  const paymentForm = document.querySelector("form");
  const inlineContainer = document.getElementById("inline-card-container");

  paymentForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const method = document.querySelector("input[name='payment_method']:checked").value;
    const orderId = <%= @order.id %>;

    if (method === "stripe_checkout") {
      // Hosted checkout
      const res = await fetch("<%= payments_create_checkout_session_path %>", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ order_id: orderId })
      });
      const data = await res.json();
      window.location.href = data.url;
    } else if (method === "card") {
      // Inline card payment
      paymentForm.style.display = "none";
      inlineContainer.style.display = "block";

      const { client_secret } = await fetch("<%= payments_create_payment_intent_path %>", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ order_id: orderId })
      }).then(r => r.json());

      const elements = stripe.elements();
      const card = elements.create("card");
      card.mount("#card-element");

      document.getElementById("pay-button").addEventListener("click", async () => {
        const result = await stripe.confirmCardPayment(client_secret, { payment_method: { card }});
        if(result.error){
          document.getElementById("card-errors").textContent = result.error.message;
        } else if(result.paymentIntent.status === "succeeded"){
          // Mark order paid
          await fetch("/orders/mark_paid", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({ order_id: orderId, payment_id: result.paymentIntent.id })
          });
          window.location.href = "<%= order_path(@order) %>";
        }
      });
    }
  });
});
</script>
